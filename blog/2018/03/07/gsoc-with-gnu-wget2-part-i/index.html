<!DOCTYPE html>
<html>
  <head>
    
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>GSoC with GNU Wget2 - Part I - Didik Setiawan</title>
        <meta name="author" content="Didik Setiawan" />
        <meta name="description" content="GSoC with GNU Wget2 - Part I" />
        <meta name="keywords" content="GSoC with GNU Wget2 - Part I, Didik Setiawan, open_source, programming, collaboration, gsoc" />

        <meta content="0" property="fb:app_id">
        <meta content="Didik Setiawan" property="og:site_name">
        
          <meta content="GSoC with GNU Wget2 - Part I" property="og:title">
        
        
          <meta content="article" property="og:type">
        
        
          <meta content="Didik Setiawan's Blog" property="og:description">
        
        
          <meta content="https://www.didiksetiawan.com/blog/2018/03/07/gsoc-with-gnu-wget2-part-i/" property="og:url">
        
        
          <meta content="2018-03-07T03:21:00+07:00" property="article:published_time">
          <meta content="https://www.didiksetiawan.com/about/" property="article:author">
        
        
          <meta content="https://www.didiksetiawan.com/static/img/logo-high-resolution.png" property="og:image">
        
        
          
          <meta content="open_source" property="article:section">
          
        
        
          
        
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@didik_swn">
        <meta name="twitter:creator" content="@didik_swn">
        
          <meta name="twitter:title" content="GSoC with GNU Wget2 - Part I">
        
        
          <meta name="twitter:url" content="https://www.didiksetiawan.com/blog/2018/03/07/gsoc-with-gnu-wget2-part-i/">
        
        
          <meta name="twitter:description" content="Didik Setiawan's Blog">
        
        

      <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
      <script type="text/javascript">window.baseurl = 'https://www.didiksetiawan.com';</script>
      
        <!-- Custom Fonts -->
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">

        <!-- FontAwesome icons -->
        <link rel="stylesheet" href="https://use.fontawesome.com/74dfc6cf47.css">

        <!-- Core BootStrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
        <!-- Material Design CSS -->
        <link rel="stylesheet" href="/static/css/bootstrap-material-design.min.css">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <!-- Custom CSS -->        
        <link rel="stylesheet" href="/static/css/thickbox.css">
        <link rel="stylesheet" href="/static/css/main.css">
        <link rel="stylesheet" href="/static/css/projects.css">

        <script type="text/javascript">
          //loadingImage is relative to project dir
          var tb_pathToImage = "/static/img/loadingAnimation.gif";
        </script>

  </head>

  <body class="home overflow-hidden">
    <div class="header-panel shadow-z-2">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-sm-4 col-xs-12">
            <div class="row-picture">
              <img alt="dstw-avatar" id="about" class="logo-img" src="/static/img/avatar.png" height="75px" width="75px">
            </div>
            <div class="row-details">
              <h4 class="list-group-item-heading">Didik Setiawan</h4>
              <p class="list-group-item-text">cat ~/.life_history | grep fun</p>
              <div class="social-icons">
	
        <a class="icon" target="_blank" href="https://www.twitter.com/didik_swn"><i class="fa fa-twitter"></i></a>
    
        <a class="icon" target="_blank" href="https://www.github.com/dstw"><i class="fa fa-github"></i></a>
    
        <a class="icon" target="_blank" href="https://www.gitlab.com/dstw"><i class="fa fa-gitlab"></i></a>
    
        <a class="icon" target="_blank" href="https://stackoverflow.com/story/dstw"><i class="fa fa-stack-overflow"></i></a>
    
</div>

            </div>
            <div class="navbar-header pull-right">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <i class="fa fa-2x fa-bars"></i>
              </button>
            </div>
          </div>
          <div class="col-md-9 col-sm-8 col-xs-12">
          <div class="row">
            <h2 class="blog-title-pro col-md-6 col-sm-12 col-xs-12 ">GSoC with GNU Wget2 - Part I</h2>
            
            <div class="col-md-6 col-sm-12 col-xs-12 searchcontrol" id="js-search">
              <input class="form-control" type="text" id="js-search__input" placeholder="Search">
              <ul class="search__results" id="js-search__results"></ul>
            </div>
            
            </div>
            <p class="info">
              
                <span class="time">07 Mar 2018</span>
              
              
                <span class="categories">
                  &raquo; 
                  
                    <a href="/category/open_source">open_source</a>
                    , 
                  
                    <a href="/category/programming">programming</a>
                    , 
                  
                    <a href="/category/collaboration">collaboration</a>
                    , 
                  
                    <a href="/category/gsoc">gsoc</a>
                    
                  
                </span>
              
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="container main outer">
      <div class="row">
        <div class="col-md-3 col-xs-12">
              <nav class="menu">
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="list-separator nav navbar-nav well well-primary post">

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12 current-menu-item gsoc-with-gnu-wget2-part-i"><a href="/" target="_self"><i class="fa fa-home"></i> Blog</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  gsoc-with-gnu-wget2-part-i"><a href="/about/" target="_self"><i class="fa fa-comments"></i> About</a></li>

	
	
	
	
	
	
    
	
	<li class="col-lg-12 col-md-12 col-sm-4 col-xs-12  gsoc-with-gnu-wget2-part-i"><a href="mailto:ds@didiksetiawan.com" target="_self"><i class="fa fa-envelope"></i> Email</a></li>

</ul>

    </div>
    </nav>

        </div>
        <div class="col-md-9 col-xs-12 full">
          <div class="post-content well">
<article class="content">
    <div class="post"><p>This series of writing summing up of what I did in Google Summer of Code (GSoC) 2017.
GSoC 2017 be held in three period of time. In this part I will tell you
about the first period.</p>

<h3 id="community-approaching">Community Approaching</h3>

<p>After looking for organizations to work on, I decide to choose GNU Wget2 (part
of GNU Project). Why I choose this organization? Some reason I can say:</p>

<ul>
  <li>The codebase is small (but not the scope, for me), it give me advantage
that it’s easy to deploy on my local machine.</li>
  <li>It use C as its primary programming language. At this time, I would like to
learn about C (Linux was influenced me) on real world application. I was
starting to learn C but just on the theory. So, working on Wget2 could help me
to learn C with practice.</li>
  <li>The GNU Project reputation is well recognized in Open Source community so
working on their project make me proud.</li>
</ul>

<p>I immediately take a look on their repository. I try to clone their repository
and build on my machine. GNU Wget2 use mailing list as their primary
communication channel, so I sent greeting to them about what project I
interesting at.<br />
The contributor of the project is so friendly. They give me some clues about
what should I do. I should do some <em>microproject</em> work to show effort from me to
understand their workflow and also their codebase. That means, I have to send a
patch (there was Github pull request at this time) to the project.  I choose to
work on adding new unit test to function <code class="highlighter-rouge">wget_robots_parse()</code> [0].  Just like
most of open source contribution, it took some process of revision of patch so
it can be merged to upstream. I respect the reviewing process, it help me learn
a lot. Also from now I learn a lot to use <em>GDB (GNU Debugger)</em> to debug
application.<br />
At first I choose to use subject “Design and Implementation of a Framework for
Plugins”. But I rethink again because what I do in microproject is about
Testing. Finally I change my subject so I take “Design and Implementation of
Test Suite Using Libmicrohttpd” as my project. I send my proposal to project’s
mailing list [1]. After some reviewing and revision process, I officially sent
my proposal to GSoC homepage and my proposal was accepted.<br />
The project aim to use Libmicrohttpd as test suite for Wget2. I planned to
complete this by change on function <code class="highlighter-rouge">wget_test_start_server()</code> also
<code class="highlighter-rouge">wget_test_stop_server()</code> from src/libtest.c of Wget2. With this
approach, I don’t need to change existing test suite which call the internal
server code through functions mentioned above.<br />
I’ve count there are 36 test file which use
<code class="highlighter-rouge">wget_test_start_server()</code>. I must ensure all the test passed.  And
for installation prerequisite, I must ensure that Libmicrohttpd are included
when building Wget2 binary. Then I need to modify configure.ac. I will give
proper warning about this requirement. There is a section in README.md where I
must explain to user to provide Libmicrohttpd to make all test running
correctly.  With Libmicrohttpd I can add new test using feature that not yet
implemented in old server code, but ready on Libmicrohttpd, such as HTTP
authentication and concurrent request checking.</p>

<h3 id="community-bonding-period">Community Bonding Period</h3>

<p>During this period, I spend my time to learn codebase about Wget2 and
Libmicrohttpd. I was busy to learning them, that I forget to stay active in
community. To prevent mentors give me minus points, I try to work on an issue. I
try an easy one, adding enhancement for capabilities of file extended
attributes. In short words, Wget2 could save target file’s extended attributes
if filesystem support it. It is like the feature on Wget 1.x. To solve this
issue, I have to dive a little bit on Wget2 codebase. That’s give me a view
about how Wget2 works.</p>

<h3 id="1st-week">1st Week</h3>

<p>There comes the first week of my official coding period. I was work on some
basic tasks for this projects, such as modify the build tools. I have modifed
configure.ac to include Libmicrohttpd into Wget2. I just include the package,
and not adding, modifying or removing anything else yet.<br />
With Libmicrohttpd becomes mandatory package to install before building Wget2
binary, there must be proper warning about this requirement, otherwise the
building process will fail. I have add oneliner information into README.md.
Actually, I was misunderstood about this. Christian Grothoff then give me
suggestion to correct it. Dependency to Libmicrohttpd should not become
mandatory. The solution it to make conditionally-compile and run the tests only
if Libmicrohttpd is present while build Wget2. Libmicrohttpd does the same for
Libcurl. Making the dependency optional also avoids the obvious possibility of
circular dependencies if we ever were to add Libwget2-based tests to
Libmicrohttpd.<br />
Tim Ruhsen also reminds that I should to skip the appropriate tests if
Libmicrohttpd is not installed/ available. I should definitely avoid to use
Wget2 legacy server code in Libwget and focus on client functionality instead.
Because after we successfully integrating Libmicrohttpd, we should remove the
legacy server code. I finally understood what they mean and will fix this the
next week.<br />
On the CI/CD section, I have ensured that all make check passed on several
testing machine including: Debian/GCC, Fedora/Clang, MingW64 and OSX.
Fortunately, most of those OS have provided Libmicrohttpd package on their
respective repository, except MingW64 (the representation of Windows build).
Especially for MingW64 build, because I haven’t found the correct package for
Libmicrohttpd, I include Libmicrohttpd by download the source and compile
manually. What I’ve done is add the following lines on .gitlab-ci.yml:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>before_script:
- dnf <span class="nt">-y</span> <span class="nb">install </span>wget
- wget http://ftp.gnu.org/gnu/libmicrohttpd/libmicrohttpd-0.9.55.tar.gz
- <span class="nb">tar </span>zxf libmicrohttpd-0.9.55.tar.gz <span class="o">&amp;&amp;</span> <span class="nb">cd </span>libmicrohttpd-0.9.55/
- mingw64-configure <span class="nt">--prefix</span><span class="o">=</span>/usr/x86_64-w64-mingw32/sys-root/mingw/
- mingw64-make <span class="nt">-j</span><span class="k">$(</span><span class="nb">nproc</span><span class="k">)</span>
- mingw64-make <span class="nt">-j</span><span class="k">$(</span><span class="nb">nproc</span><span class="k">)</span> <span class="nv">LOG_COMPILER</span><span class="o">=</span>wine <span class="nb">install</span>
- <span class="nb">cd</span> -
</code></pre></div></div>

<p>I asking if my step was right. Tim give me advice on that MingW64 issue, that I
should provide a script (e.g. in contrib/ folder) that will
downloads/builds/installs Libmicrohttpd. That script then added to the CI runner
YAML file(s) so we can test on MinGW64 as well. This will keep us to stay run as
many tests as possible. He suggest that I should move my MinGW64 build script to
contrib in the end of GSOC as a cleanup.<br />
On the other hand, Evgeny Grin tell me there is a package for Libmicrohttpd on
MinGW64, it provided on Msys2 project and has HTTPS support. Another solution,
is to use W32 binary build provided on GNU mirrors, but it has not HTTPS
support. I keep this information for later decision. For now, I should focus on
the test code first.</p>

<h3 id="2nd-week">2nd Week</h3>

<p>Things get more interesting. Because in this period, I will starting to work on
Wget2 main testing function. I started on <code class="highlighter-rouge">wget_test_start_server()</code>.
I must change that function in order to call Libmicrohttpd as service for
<code class="highlighter-rouge">wget_test()</code>. Workflow to resolve this:</p>

<ul>
  <li>Disable initial process for HTTP server socket.</li>
  <li>Disable <code class="highlighter-rouge">_http_server_thread</code>, instead call new function which call
Libmicrohttpd.</li>
  <li>Create <code class="highlighter-rouge">_http_server()</code> function, wrapper for Libmicrohttpd. There
is also function <code class="highlighter-rouge">ahc_eco()</code> which use to create proper HTTP
response.</li>
</ul>

<p>Some issues I found in this period:</p>

<ul>
  <li>Decide what the best threading model for Libmicrohttpd. I currently using
<code class="highlighter-rouge">MHD_USE_INTERNALLY_POLLING_THREAD</code> which use external select. I still check
the comparison with legacy code that use Wget2 API <code class="highlighter-rouge">wget_thread_start</code>.
Darshit Shah give me a clue, that I should choose any mechanism that uses
<code class="highlighter-rouge">select()</code>. Then we can change the threading model at a later stage if it
turns out to be a bottleneck. <code class="highlighter-rouge">epoll</code> is Linux-only and even <code class="highlighter-rouge">poll</code> isn’t
always available, so as long as I choose a <code class="highlighter-rouge">select</code> based implementation, it
should be fine. Evgeny said that I can use <code class="highlighter-rouge">MHD_is_feature_supported()</code> with
<code class="highlighter-rouge">MHD_FEATURE_POLL</code> and <code class="highlighter-rouge">MHD_FEATURE_EPOLL</code> to check for supported polling
functions.  Alternatively, with latest versions of Libmicrohttpd I can use
<code class="highlighter-rouge">MHD_USE_AUTO</code> and Libmicrohttpd will choose <code class="highlighter-rouge">select()</code>, <code class="highlighter-rouge">poll()</code> or
epoll-based polling automatically.</li>
  <li>
    <p>I make the <code class="highlighter-rouge">http_server_port</code> still hardcoded. Darshit tell me that this
becomes important note. The port should be a random number. Usually, passing 0
in the port number makes the kernel choose an open one for it. Having a
randomised port is important to ensure that multiple runs don’t step on each
other.<br />
I think still don’t know how to accomplish this. Maybe, it just my understanding
that when I pass 0 in MHD port number, the result is still 0.  Another
approach, when I look into the old code, it generate port number by calling
<code class="highlighter-rouge">wget_tcp_get_local_port()</code>. But, I need to call <code class="highlighter-rouge">wget_tcp_init()</code> and
<code class="highlighter-rouge">wget_tcp_listen()</code> respectively in order to get proper result.  Conclusion, do
I need to use existing <code class="highlighter-rouge">wget_tcp_get_local_port()</code> to get the port, or maybe
there is a function in Libmicrohttpd to do that.<br />
Tim added that all I need is the socket descriptor. How to call
<code class="highlighter-rouge">getsockname()</code> + <code class="highlighter-rouge">getnameinfo()</code> to retrieve the port number I see in
<code class="highlighter-rouge">libwget/net.c</code>/ <code class="highlighter-rouge">wget_tcp_get_local_port()</code>. If Libmicrohttpd doesn’t have
such a function, either try to get the socket descriptor or extend
Libmicrohttpd with a small function (similar code as in
<code class="highlighter-rouge">wget_tcp_get_local_port</code>).<br />
Evgeny give more detailed explanations. There are several ways to resolve it:</p>

    <ol>
      <li>Initialise socket externally and start <code class="highlighter-rouge">listen()</code> on it. I can use any bind
and port detection function. Pass socket <code class="highlighter-rouge">FD</code> to <code class="highlighter-rouge">MHD_start_daemon()</code> by
<code class="highlighter-rouge">MHD_OPTION_LISTEN_SOCKET</code>.</li>
      <li>Use <code class="highlighter-rouge">MHD_start_daemon()</code> with “0” as port number then use
<code class="highlighter-rouge">MHD_get_daemon_info()</code> with <code class="highlighter-rouge">MHD_DAEMON_INFO_LISTEN_FD</code> to get listen
socket FD. Use any port detection.</li>
      <li>Use <code class="highlighter-rouge">MHD_start_daemon()</code> with “0” as port number then use
<code class="highlighter-rouge">MHD_get_daemon_info()</code> with <code class="highlighter-rouge">MHD_DAEMON_INFO_BIND_PORT</code> to get port
number.  Works with <code class="highlighter-rouge">MHD_VERSION &gt;= 0x00095501</code> and on platforms that
support <code class="highlighter-rouge">getsockname()</code>.<br />
I can combine second and third methods.</li>
    </ol>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kt">int</span> <span class="n">port_num</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
<span class="cp">#if MHD_VERSION &gt;= 0x00095501
</span>  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">MHD_NO</span> <span class="o">!=</span>
     <span class="n">MHD_is_feature_supported</span> <span class="p">(</span><span class="n">MHD_FEATURE_AUTODETECT_BIND_PORT</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="k">union</span> <span class="n">MHD_DaemonInfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
    <span class="n">dinfo</span> <span class="o">=</span> <span class="n">MHD_get_daemon_info</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">MHD_DAEMON_INFO_BIND_PORT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dinfo</span> <span class="o">||</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Insert code to handle error. */</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">port_num</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* MHD_VERSION &gt;= 0x00095501 */</span><span class="cp">
</span>  <span class="k">else</span>
  <span class="p">{</span>
    <span class="k">const</span> <span class="k">union</span> <span class="n">MHD_DaemonInfo</span> <span class="o">*</span><span class="n">dinfo</span><span class="p">;</span>
    <span class="n">MHD_socket</span> <span class="n">sock_fd</span><span class="p">;</span>
    <span class="n">dinfo</span> <span class="o">=</span> <span class="n">MHD_get_daemon_info</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">MHD_OPTION_LISTEN_FD</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dinfo</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="cm">/* Insert code to handle error. */</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sock_fd</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">listen_fd</span><span class="p">;</span>
    <span class="cm">/* Insert code to use port detection on provided socket. */</span>
  <span class="p">}</span>

</code></pre></div></div>
<p>He add note that socket type used by MHD functions is <code class="highlighter-rouge">MHD_socket</code>.
<code class="highlighter-rouge">MHD_socket</code> is <code class="highlighter-rouge">int</code> on POSIX platforms (Linux, *BSD, Unix, Darwin) and
<code class="highlighter-rouge">SOCKET</code> on Windows platform (excluding Cygwin, where <code class="highlighter-rouge">MHD_socket</code> is <code class="highlighter-rouge">int</code>).</p>

<ul>
  <li>In <code class="highlighter-rouge">ahc_eco()</code> of Libmicrohttpd, urls data still using static checking for
matching with requested urls. In other word, it’s hardcoded. It needs to be
changed to dynamic method to accomodate variadic data.</li>
  <li>I still not touched HTTPS yet.</li>
  <li>I ask about what to do with FTP and FTPS functions. Since Libmicrohttpd just
provide service for HTTP. I was asking, do we need keep the function for
FTP{s}, or removing it. Darshit told me that we keep the FTP code intact for
now. Then we should look into different libraries that provide a FTP server in
C and try to integrate that into your test suite as well. But for this period,
it is out of scope.</li>
  <li>The test was failed when I try to resolve URL with question mark. For example:
<code class="highlighter-rouge">/subdir1/subpage1.html?query&amp;param</code>, when I debug, it return just
<code class="highlighter-rouge">/subdir1/subpage1.html</code> so the result is 404 not found. I also check using
logging example source code provided in Libmicrohttpd tutorial. When I access
using http client such as Wget2 and Firefox, the result is still the same. The
URL result omit the query part. I confirm to Libmicrohttpd side about
this, whether it is intended behaviour or not. Christian said it that’s
intended, for URL parameters/arguments I need to use
<code class="highlighter-rouge">MHD_get_connection_values()</code> with <code class="highlighter-rouge">kind=MHD_GET_ARGUMENT_KIND</code> to inspect
them.</li>
</ul>

<h3 id="3rd-week">3rd Week</h3>

<p>Based on feedback from mentors on the previous week, I made some fixes.</p>

<ul>
  <li>Remove initial process for HTTP server socket.</li>
  <li>Create <code class="highlighter-rouge">_http_server_start()</code> function, wrapper for Libmicrohttpd. There is
also function <code class="highlighter-rouge">answer_to_connection()</code> which use to create proper HTTP
response.</li>
  <li>Use select method <code class="highlighter-rouge">(MHD_USE_SELECT_INTERNALLY)</code> for threading model in
Libmicrohttpd to get better compatibility.</li>
  <li><code class="highlighter-rouge">http_server_port</code> seized automatically using Libmicrohttpd function by
passing <code class="highlighter-rouge">MHD_DAEMON_INFO_BIND_PORT</code> or <code class="highlighter-rouge">MHD_DAEMON_INFO_LISTEN_FD</code> parameter
to <code class="highlighter-rouge">MHD_get_daemon_info()</code>.</li>
  <li>Using iteration to parse urls data in <code class="highlighter-rouge">answer_to_connection()</code>. This
guarantee we can pass any variadic data to Libmicrohttpd and prevent
segmentation fault.</li>
  <li>Fix <code class="highlighter-rouge">answer_to_connection()</code> function to create proper HTTP response (to deal
with parameters and arguments on url, to add proper HTTP headers).</li>
</ul>

<h3 id="4th-week">4th Week</h3>

<p>Finally it comes to the end of the first period. I report to mentors what I’ve
done in this week.</p>

<ul>
  <li>I have finished modify configure.ac to include Libmicrohttpd into Wget2.</li>
  <li>I have ensured that all make check passed on several testing machine
including: Debian/GCC, Fedora/Clang, MingW64 and OSX.</li>
  <li>
    <p>Started working on <code class="highlighter-rouge">wget_test_start_server()</code>. Workflow to resolve this:</p>

    <ul>
      <li>Remove initial process for HTTP server socket.</li>
      <li>Create <code class="highlighter-rouge">_http_server_start()</code> function, wrapper for Libmicrohttpd. There is
also function <code class="highlighter-rouge">answer_to_connection()</code> which use to create proper HTTP
response.</li>
      <li>Use select method (<code class="highlighter-rouge">MHD_USE_SELECT_INTERNALLY</code>) for threading model in
Libmicrohttpd to get better compatibility.</li>
      <li>http_server_port seized automatically using Libmicrohttpd function by
passing <code class="highlighter-rouge">MHD_DAEMON_INFO_BIND_PORT</code> or <code class="highlighter-rouge">MHD_DAEMON_INFO_LISTEN_FD</code> parameter
to <code class="highlighter-rouge">MHD_get_daemon_info()</code>.</li>
      <li>Using iteration to parse urls data in <code class="highlighter-rouge">answer_to_connection()</code>. This
guarantee we can pass any variadic data to Libmicrohttpd and prevent
segmentation fault.</li>
      <li>Fix <code class="highlighter-rouge">answer_to_connection()</code> function to create proper HTTP response (to deal
with parameters and arguments on url, to add proper HTTP headers).</li>
    </ul>
  </li>
  <li>I must ensure that all test suite running correctly. To give better
visualization, I’ve created spreadsheet about summary of test file which use
<code class="highlighter-rouge">wget_test_start_server()</code>. Currently, as far as I know, it reaches 87.5% (28
of 32). I need to complete all test suite reach 100%.</li>
</ul>

<p>After I send it to the mailing list, I have got many feedback from my mentors
for this report.</p>

<p>When Darshit trying to check my code, he has noticed that I was working only
on a single branch and have only one commit until the date. This much work is
not enough for the mid semester evaluation. He asks me to split my work into
smaller commits which are discrete units of work. I follow up this with breaking
down my previous one big commit into smaller ones so it could represent my work
in period of time.<br />
About the commit style, he gave me a clear clue. My commit messages are pretty
hard to read. Also, he asks to maintain the standard style of commit messages.
At Wget, the commit messages are converted into a ChangeLog, hence my message
should be written in that format.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git commit

Commit Message title (60 chars)
[Blank Line]
* file_changed(function_name): Description of change
* file_changed(function_name): Description of change

Any other details I want to write
</code></pre></div></div>

<p>The commit messages I have written are actually fine, but when it exceeds 60 chars in
the first line, I should convert my message to the longer format he just
described.<br />
Another thing, he asks to not force push to my (<em>master</em>) branches. There are
other people that pull from these branches to check in on the code. If I force
push, it messes the repository up for all. Force pushing should only be reserved
as a last resort. However, in this case, when I rewrite the commit messages, I
should force push to my own current branch. That will allow me to maintain that
branch later.<br />
The CI system states failures. He asks whether this is an expected failures. I
said that it not intended to be failure. On my machine which use Ubuntu/GCC, I
can run <code class="highlighter-rouge">make check</code>, and some test could pass. Same like on Gitlab CI that use
Debian/GCC. Based on CI artifacts, most of them failed on <code class="highlighter-rouge">make check-valgrind</code>
that I miss to check before. I still find out how to deal with this memory leak
error. Actually, I still stuck in this. Then I ask, how to debug using Valgrind.
I read the error logs and it still it pointed me out of nowhere. He said that I
really should discuss these issues with them more. That is exactly why they are
here to mentor me. Valgrind’s memcheck tool which is what is being used in the
<code class="highlighter-rouge">make check-valgrind</code> is a memory leak checker. He will look a little into it
once he can get the basic tests running on his machine. I asked to be focus on
that first. He said we will look into the memory leaks in a while. Most probably
the leaks happen because either I lost the pointer to some allocated memory or
are using the libmicrohttpd API wrong and forgot to <code class="highlighter-rouge">free()</code> some data structure
returned by it.<br />
He also sees that ./configure always tries to link Libmicrohttpd. But Wget2
should not depend on that. It should try to add the linker flags <em>only</em> when
trying to compile the test suite. The Wget2 binary should not use that flag. I
realize that was there are flaws in my code. I will figure out after some work
against other test files.<br />
On his local system, not a single test passes. <code class="highlighter-rouge">make check -j$(nproc)</code> causes a
segmentation fault and a simple <code class="highlighter-rouge">make check</code> gets stuck on test-wget-1 and never
progresses ahead. He asks me to fix the branch and/or provide them with
information on how to make the tests work. I look at CI system with Fedora/Clang
and indeed the result is all segmentation faults. I still have no clue about
that. With this case, I cannot claim that I have almost 85% tests passing
already. From his perspective, it is still 0%.<br />
In fact, all the tests that my spread sheet marks are passes, end up causing a
segfault on his system. This seems to stem from the fact that the
<code class="highlighter-rouge">http_server_tid</code> is stored as “0” and I try to call <code class="highlighter-rouge">pthread_cancel</code> on that
value. I asks for more detail information about this. I have use some advice
from Evgeny Grin how to deal with dynamic port. Even when I use hard coded port,
the result is still the same. He explains that he don’t think this is connected
to the port number at all. If it is, then my variable naming scheme requires a
serious change. This issue is happening because I have never stored the tid of
the server in the variable, but I still try to cancel that thread id. After I
take a look on my code again, I realize something wrong. Darshit was right. That
segmentation fault error happened because I forgot to remove
<code class="highlighter-rouge">wget_thread_cancel</code>(<code class="highlighter-rouge">http_server_tid</code>) which is used by the old code at server
termination time. After I remove that line, the CI runner of Fedora/Clang
passes some tests, not all test were resulted segmentation fault (14 of 32
pass, while 4 skipped). The other fail because likely Valgrind check error.<br />
Darshit asks me to make sure that my code works as I have mentioned at least one day
before the deadline for the evaluations. On my Week 3 report I planned to get
100% of passing all of the test suite. But, until Week 4, my job still not yet
all done (even excluding other error generated outside <code class="highlighter-rouge">make check</code> on
Debian/GCC system). I realized I have missed my (personal) target. Hence, he
asks me where do I think I missed out which caused me to fall behind. In
hindsight, he asks what according to me could have been done better. So, I and
they should be look into this together to see where it can be improved. He asks
what topics were I most stuck on, and why did it take me so much time. Also, if
I stuck on any single point for more than a day, he asks to send they a message.
There is a very good chance that they might be able to help me out and fix it
much faster.<br />
Darshit sends a message to both Libmicrohttpd maintainers, Christian and Evgeny:
that the issues in Valgrind seem to come from within Libmicrohttpd. One of the
blocks reported by Valgrind is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>=26290== 72 bytes in 3 blocks are still reachable in loss record 6 of 6
==26290==    at 0x4C2BEEF: malloc (in
/usr/lib/valgrind/vgpreload_memcheck-amd64-linux.so)
==26290==    by 0x7E06608: ??? (in /usr/lib/libgcrypt.so.20.1.7)
==26290==    by 0x7E077FB: ??? (in /usr/lib/libgcrypt.so.20.1.7)
==26290==    by 0x7EBEFB1: ??? (in /usr/lib/libgcrypt.so.20.1.7)
==26290==    by 0x7EBF02F: ??? (in /usr/lib/libgcrypt.so.20.1.7)
==26290==    by 0x7E0655F: ??? (in /usr/lib/libgcrypt.so.20.1.7)
==26290==    by 0x7E06764: ??? (in /usr/lib/libgcrypt.so.20.1.7)
==26290==    by 0x6634CF8: ??? (in /usr/lib/libmicrohttpd.so.12.43.0)
==26290==    by 0x400F339: call_init.part.0 (in /usr/lib/[1]ld-2.25.so)
==26290==    by 0x400F445: _dl_init (in /usr/lib/[2]ld-2.25.so)
==26290==    by 0x4000D39: ??? (in /usr/lib/[3]ld-2.25.so)
==26290==    by 0x9: ???
</code></pre></div></div>

<p>So, he guess is that this is some memory that is being allocated by Libmicrohttpd.
The test code does indeed seem to call <code class="highlighter-rouge">MHD_stop_daemon()</code> which should
ideally ensure a clean exit. He asks, where did the implementation go wrong.<br />
Christian said this is a bit hard to evaluate without the debug symbols. Most
likely it would be a false-positive from a globally allocated buffer of
Libgcrypt’s initialization sequence. He asks to download and install debug
symbols for Libgcrypt and ideally Libmicrohttpd. It is unlikely to be
Libmicrohttpd fault, as except for responses there are no Libmicrohttpd buffers
my code would have to free.<br />
Evgeny gives a review about my works, direct pointed to the code.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">_scan_directory</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">path</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">return</span> <span class="n">path</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span>
              <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>He asks why do I use underscore as prefix for functions. Usually it is used by
libraries to avoid name conflict. First, I think that I need to remove the
underscore, then Tim also give comment that this is also useful in projects
where there is more than one C file. They use it to make clear that a
function/variable is static (not consequently everywhere, though). So, I
still keep the underscore.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">_parse_hostname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wget_strncasecmp_ascii</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"http://"</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
              <span class="kt">char</span> <span class="o">*</span><span class="n">path</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">data</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">);</span>
              <span class="k">return</span> <span class="n">path</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span>
              <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">_replace_space_with_plus</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">strchr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="sc">' '</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="kt">char</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
              <span class="kt">char</span> <span class="o">*</span><span class="n">wk</span><span class="p">,</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

              <span class="n">wk</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

              <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">){</span>
                              <span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'+'</span><span class="p">;</span>
                              <span class="o">++</span><span class="n">s</span><span class="p">;</span>
                      <span class="p">}</span> <span class="k">else</span>
                              <span class="o">*</span><span class="n">data</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
              <span class="n">free</span><span class="p">(</span><span class="n">wk</span><span class="p">);</span>
              <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span>
              <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>He asks me about the reason for using <code class="highlighter-rouge">strdup()</code>/<code class="highlighter-rouge">free()</code>. I checked string
twice (by <code class="highlighter-rouge">strchr()</code> and by my custom iterations). It just waste of CPU time.
He gives simpler implementation:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="k">while</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="sc">' '</span> <span class="o">==</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
      <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="sc">'+'</span><span class="p">;</span>
    <span class="n">data</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I applied the changes to my code.<br />
Evgeny also give note that according to current HTTP specification ‘+’ must NOT be
used as replacement for ‘ ’ in URLs. When I learn about this problem, it
leads me to here [2]. Then if it need to be applied, I need to modify test
file: test-base.c to not use ‘+’, and use %2B instead.<br />
Tim added that the ‘+’ was always just for the query part. He asks to Evgeny
what document are you exactly referring to to. Not that he is against dropping
the ‘+’ rule, but what consortium is not accepted as normative by everyone,
while IETF is. He is unsure about what ‘spec’ to follow. So, I keep my changes
of ‘+’.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">print_out_key</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span> <span class="k">enum</span> <span class="n">MHD_ValueKind</span> <span class="n">kind</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
                                              <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">url_it</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">url_it2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">wget_buffer_strcpy</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="s">"?"</span><span class="p">);</span>
              <span class="n">_replace_space_with_plus</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">);</span>
</code></pre></div></div>

<p>Evgeny said that we are not allowed to modify any content pointed by pointer to
const. By dropping ‘const’ qualifiers are violating API. In other words: I was
modifying internal structures that are not expected to be modified and the
result is unpredictable. I fixed them then.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>              <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="s">"="</span><span class="p">);</span>
                      <span class="n">_replace_space_with_plus</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
                      <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
              <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">url_it</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">url_it2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="s">"&amp;"</span><span class="p">);</span>
              <span class="n">_replace_space_with_plus</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">key</span><span class="p">);</span>
              <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
                      <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="s">"="</span><span class="p">);</span>
                      <span class="n">_replace_space_with_plus</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
                      <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_arg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
              <span class="p">}</span>
      <span class="p">}</span>
      <span class="n">url_it</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">MHD_YES</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>He also gives me some questions:</p>

<ul>
  <li>Is <code class="highlighter-rouge">url_arg</code> a global variable?</li>
  <li>Do I use single thread only?</li>
  <li>Why not to pass pointer to <code class="highlighter-rouge">url_arg</code> as <code class="highlighter-rouge">cls</code>?</li>
  <li>What about <code class="highlighter-rouge">url_it</code> and <code class="highlighter-rouge">url_it2</code>? It is hard to guess meaning from name.</li>
</ul>

<p>If I need to pass all of them, I was advised to define some structure with three
pointers and pass pointer to structure.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">answer_to_connection</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
                                      <span class="k">struct</span> <span class="n">MHD_Connection</span> <span class="o">*</span><span class="n">connection</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">upload_data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">upload_data_size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">con_cls</span><span class="p">)</span>
<span class="p">{</span>
      <span class="k">struct</span> <span class="n">MHD_Response</span> <span class="o">*</span><span class="n">response</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

      <span class="n">url_arg</span> <span class="o">=</span> <span class="n">wget_buffer_alloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
      <span class="n">MHD_get_connection_values</span> <span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">MHD_GET_ARGUMENT_KIND</span><span class="p">,</span> <span class="n">print_out_key</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

      <span class="n">url_it2</span> <span class="o">=</span> <span class="n">url_it</span><span class="p">;</span>
      <span class="n">wget_buffer_t</span> <span class="o">*</span><span class="n">url_full</span> <span class="o">=</span> <span class="n">wget_buffer_alloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
      <span class="n">wget_buffer_strcpy</span><span class="p">(</span><span class="n">url_full</span><span class="p">,</span> <span class="n">url</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">url_arg</span><span class="p">)</span>
              <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_full</span><span class="p">,</span> <span class="n">url_arg</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">url_full</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>
              <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_full</span><span class="p">,</span> <span class="s">"index.html"</span><span class="p">);</span>
      <span class="n">url_it</span> <span class="o">=</span> <span class="n">url_it2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">itt</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">itt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">itt</span> <span class="o">&lt;</span> <span class="n">nurls</span><span class="p">;</span> <span class="n">itt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="kt">char</span> <span class="o">*</span><span class="n">dir</span> <span class="o">=</span> <span class="n">_scan_directory</span><span class="p">(</span><span class="n">url_full</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>
                      <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_full</span><span class="p">,</span> <span class="s">"index.html"</span><span class="p">);</span>

              <span class="kt">char</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">_parse_hostname</span><span class="p">(</span><span class="n">url_full</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>
                      <span class="n">wget_buffer_strcat</span><span class="p">(</span><span class="n">url_full</span><span class="p">,</span> <span class="s">"index.html"</span><span class="p">);</span>

              <span class="n">wget_buffer_t</span> <span class="o">*</span><span class="n">iri_url</span> <span class="o">=</span> <span class="n">wget_buffer_alloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
              <span class="n">wget_buffer_strcpy</span><span class="p">(</span><span class="n">iri_url</span><span class="p">,</span> <span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
              <span class="n">MHD_http_unescape</span><span class="p">(</span><span class="n">iri_url</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

              <span class="k">if</span> <span class="p">(</span><span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">code</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
                      <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">code</span><span class="p">,</span> <span class="s">"302 Redirect"</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                      <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">url_full</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">iri_url</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
              <span class="p">{</span>
                      <span class="n">response</span> <span class="o">=</span> <span class="n">MHD_create_response_from_buffer</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="s">"302 Redirect"</span><span class="p">),</span>
                                      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="s">"302 Redirect"</span><span class="p">,</span> <span class="n">MHD_RESPMEM_PERSISTENT</span><span class="p">);</span>
                      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">itt2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">headers</span><span class="p">[</span><span class="n">itt2</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">itt2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                              <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">headers</span><span class="p">[</span><span class="n">itt2</span><span class="p">];</span>
                              <span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="p">{</span>
                                      <span class="kt">char</span> <span class="o">*</span><span class="n">header_value</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="sc">':'</span><span class="p">);</span>
                                      <span class="kt">char</span> <span class="o">*</span><span class="n">header_key</span> <span class="o">=</span> <span class="n">wget_strmemdup</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">header_value</span> <span class="o">-</span> <span class="n">header</span><span class="p">);</span>
                                      <span class="n">MHD_add_response_header</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">header_key</span><span class="p">,</span> <span class="n">header_value</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
                                      <span class="n">ret</span> <span class="o">=</span> <span class="n">MHD_queue_response</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">MHD_HTTP_FOUND</span><span class="p">,</span> <span class="n">response</span><span class="p">);</span>
                                      <span class="n">wget_xfree</span><span class="p">(</span><span class="n">header_key</span><span class="p">);</span>
                                      <span class="n">itt</span> <span class="o">=</span> <span class="n">nurls</span><span class="p">;</span>
                                      <span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                              <span class="p">}</span> <span class="k">else</span>
                                      <span class="n">itt</span> <span class="o">=</span> <span class="n">nurls</span><span class="p">;</span>
                      <span class="p">}</span>
              <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">url_full</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">iri_url</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
                      <span class="n">response</span> <span class="o">=</span> <span class="n">MHD_create_response_from_buffer</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">body</span><span class="p">),</span>
                                      <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">urls</span><span class="p">[</span><span class="n">itt</span><span class="p">].</span><span class="n">body</span><span class="p">,</span> <span class="n">MHD_RESPMEM_PERSISTENT</span><span class="p">);</span>
</code></pre></div></div>

<p>He asks me again to ensure that content of <code class="highlighter-rouge">urls[itt].body</code> will be valid until
end of this connection. Otherwise you must use <code class="highlighter-rouge">MHD_RESPMEM_MUST_COPY</code> as last
parameter. I followed his advice and fix my code.</p>

<p>Two generic advises he gave to me:</p>

<ul>
  <li>Avoid using global variables.</li>
  <li>Use better names for variables. It it hard to understand what mean
<code class="highlighter-rouge">iri_url</code>, <code class="highlighter-rouge">itt</code> and <code class="highlighter-rouge">itt2</code>.</li>
</ul>

<h3 id="first-period-evaluations">First Period Evaluations</h3>

<p>After finish my 4th period report, I also must complete first evaluation report
via GSoC web app. I passed the evaluations, but with warning. Mentors give me an
important messages about what happened and what should I improve.<br />
The project is indeed behind schedule. The mentors still give me a chance by passing
me in the hopes that I and they will be able to improve the communication and
get the project back on track. One major suggestion is that I increase the
frequency of my project reports from weekly to daily. Just a single line at the
end of each day stating what I have done and what are my plans for the next
day.</p>

<h3 id="conclusion">Conclusion</h3>

<p>That was though days with my first time period of GSoC. There was many jobs left
to be finished in the next period. Mistakes happen, but I was learn a lot from
them.</p>

<p>Reference(s):<br />
[0] <a href="https://github.com/rockdaboot/wget2/pull/155">https://github.com/rockdaboot/wget2/pull/155</a><br />
[1] <a href="https://lists.gnu.org/archive/html/bug-wget/2017-03/msg00156.html">https://lists.gnu.org/archive/html/bug-wget/2017-03/msg00156.html</a><br />
[2] <a href="https://stackoverflow.com/questions/1005676/urls-and-plus-signs">https://stackoverflow.com/questions/1005676/urls-and-plus-signs</a></p>
</div>
    <hr />
    <div class="share-page">
    Share this on &rarr;
 <a href="https://twitter.com/share" class="twitter-share-button" data-via="didik_swn">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

<!-- Google + -->
<div class="g-plus" data-action="share" data-annotation="bubble"></div>
<script src="https://apis.google.com/js/platform.js" async defer></script>

<!-- Facebook -->
<div class="fb-share-button" data-href="https://www.didiksetiawan.com/blog/2018/03/07/gsoc-with-gnu-wget2-part-i/" data-layout="button_count" style="position: relative; top: -8px; left: 3px;"></div>
</div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6&appId=0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</article>
<hr />


    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
                
                <div class="panel-body">
                <h4>Related Posts</h4>
                <ul>
                
                <li class="relatedPost">
                    <a href="https://www.didiksetiawan.com/blog/2017/04/08/workflow-on-contributing-to-open-source/">Workflow on Contributing to Open Source Project</a>
                    
                        <small>(Categories: <a href="/category/open_source">open_source</a>, <a href="/category/collaboration">collaboration</a>, <a href="/category/programming">programming</a>)</small>
                    
                </li>
                
                
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
                
                <li class="relatedPost">
                    <a href="https://www.didiksetiawan.com/blog/2017/04/05/google-summer-of-code-preparation/">Google Summer of Code Preparation</a>
                    
                        <small>(Categories: <a href="/category/open_source">open_source</a>, <a href="/category/collaboration">collaboration</a>, <a href="/category/programming">programming</a>, <a href="/category/gsoc">gsoc</a>)</small>
                    
                </li>
                
                
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    

    
    
        
            
        
            
        
            
        
            
        
    
        
            
        
            
        
            
        
            
        
    


    </ul>
    </div>


<div class="PageNavigation">
  
    <a class="prev pull-left" href="https://www.didiksetiawan.com/blog/2017/04/08/workflow-on-contributing-to-open-source/">&laquo; Workflow on Contributing to Open Source Project</a>
  
  
</div>


<div class="disqus-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* <![CDATA[ */

        var disqus_shortname = "didiksetiawan";
        var disqus_identifier = "https://www.didiksetiawan.com_GSoC with GNU Wget2 - Part I";
        var disqus_title = "GSoC with GNU Wget2 - Part I";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    /* ]]> */
    </script>
</div>
</div>
          <div class="row">
            <div class="col-md-12 col-xs-12 footer">
              <footer>
	© 2009-2018 Didik Setiawan - Powered by Jekyll.
</footer>

            </div>
          </div>
        </div> <!-- end /.col-md-9 -->
      </div> <!-- end /.row -->
    </div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<script src="/static/js/super-search.js"></script>

<script src="/static/js/thickbox-compressed.js"></script>
<script src="/static/js/material.min.js"></script>
<script src="/static/js/main.js"></script>
<script src="/static/js/projects.js"></script>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78151571-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
